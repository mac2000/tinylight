(function(c){c.widget("mac.tinylight",{wasLength:0,nowLength:0,holder:void 0,toolbar:void 0,frame:void 0,wnd:void 0,doc:void 0,buttons:[],options:{cleanupLengthTrigger:100,height:300,fontSize:"100%",fontFamily:"Helvetica,Arial,sans-serif",backgroundColor:"white",blockTag:"p",updateOnKeyUp:!1},cleanupHtml:function(a){var b;a=a.replace(/\u2122/g,"TM").replace(/\u2026/g,"...").replace(/\x93|\x94|\u201c|\u201d/g,'"').replace(/\x60|\x91|\x92|\u2018|\u2019/g,"'").replace(/\u2013|\u2014|\u2015|\u2212/g,
"-");a=a.replace(/\s+/g," ").replace(/[\t\r\n\n]+/g,"").replace(/>\s+</g,"><").replace(/<br\s*\/?>/gi,"<br>");a=a.replace(/<(div|p)>(<br>)?<\/\1>/gi,"<p>&nbsp;</p>");a=a.replace(/<(div|p)><(ul|ol)>/gi,"<$2>").replace(/<\/(ul|ol)><\/(div|p)>/gi,"</$1>");for(b=c("<div>").html(a);0<c("*:empty:not(br)",b).size();)c("*:empty:not(br)",b).remove();b.children("br").filter(function(){return!this.parentNode||"li"!==this.parentNode.nodeName}).remove();c("*").filter(function(){return 3===this.nodeType&&/\s+/.test(this.nodeValue)}).remove();
b.contents().filter(function(){return 3===this.nodeType}).wrap("<p />");b.contents().filter(function(){return 8===this.nodeType}).remove();a=c("p",b).filter(function(a,b){return RegExp("mso-list","gi").test(c(b).attr("style"))});c.each(a,function(a,b){var d,e=/^[0-9a-np-z]/i.test(c.trim(c(b).text()).replace(/(&lt;|<)!--\[if !supportLists\]--(&gt;|>)/gi,""))?"ol":"ul";b.innerHTML=b.innerHTML.replace(RegExp("(&lt;|<)!--\\[if !supportLists\\]--(&gt;|>).+\\1!--\\[endif\\]--\\2","gi"),"");d=0<c(b).find("span[lang]:first").size()?
c(b).find("span[lang]:first").html():c(b).html();c(b).replaceWith("<"+e+"><li>"+d+"</li></"+e+">")});b.html(b.html().replace(/<\/(o|u)l>\s*<(o|u)l>/gi,""));a=c("li",b).filter(function(a,b){return 0<c(b).find("ul, ol").size()});a.each(function(a,b){var d=c(b).find("ul:first, ol:first");c(d.html()).insertAfter(b);d.remove()});c("ul, ol",b).each(function(a,g){var d=c(g).parent()[0];d!==b&&c(d).replaceWith(c(d).html())});c("strong",b).replaceWith(function(){return"<b>"+c(this).html()+"</b>"});c("em",
b).replaceWith(function(){return"<i>"+c(this).html()+"</i>"});c("h1, h2, h3, h4, h5, h6",b).replaceWith(function(){return"<p><b>"+c(this).html()+"</b></p>"});for(c("span",b).each(function(a,b){var d="",e="",h=c(b).css("font-weight").toString()||"";if(("bold"===h||"700"===h)&&0===c(b).closest("b").size())d="<b>",e="</b>";"italic"===c(b).css("font-style")&&0===c(b).closest("i").size()&&(d+="<i>",e="</i>"+e);"underline"===c(b).css("text-decoration")&&0===c(b).closest("u").size()&&(d+="<u>",e="</u>"+
e);c(b).replaceWith(d+c(b).html()+e)});0<c("*:empty:not(br)",b).size();)c("*:empty:not(br)",b).remove();c("div",b).replaceWith(function(){return"<p>"+c(this).html()+"</p>"});jQuery("*:not(b, i, u, ol, ul, li, p, br)",b).remove();c("*",b).each(function(a,b){for(var c=b.attributes,e=c.length;0<e;)e-=1,b.removeAttributeNode(c[e])});a=b.html();a=a.replace(/<\/(b|i|u)>\s*<\1>/gi,"");a=a.replace(/>\s+</g,"><");return a=a.replace(/\s*(<\/?\w+>)\s*/g,"$1")},setHtml:function(a){a=this.cleanupHtml(a);this.doc.body.innerHTML=
a;this.element.val(a)},getHtml:function(){return this.doc.body.innerHTML},_selectedNode:function(){var a;return void 0!==this.doc.caretPos&&void 0!==this.doc.caretPos.parentElement?this.doc.caretPos.parentElement():void 0!==this.wnd.getSelection&&(a=this.wnd.getSelection(),a=a.focusNode)?"#text"===a.nodeName?a.parentNode:a:null},_addButton:function(a){var b,f=this;b=c('<span class="mac-tinylight-toolbar-button" data-command="'+a+'" unselectable="on">'+a+"</span>").appendTo(f.toolbar);b.on("mousedown",
function(b){b.preventDefault();f.doc.execCommand(a);f._updateToolbar();return!1});f.buttons.push(b)},_updateToolbar:function(){var a=this;0<a.buttons.length&&c.each(a.buttons,function(b,c){var g=c.data("command"),d=a.doc.queryCommandEnabled(g);c.toggleClass("mac-tinylight-toolbar-button__active",a.doc.queryCommandState(g));c.toggleClass("mac-tinylight-toolbar-button__disabled",!d);d?c.removeAttr("disabled"):c.attr("disabled","disabled")})},_create:function(){var a=this,b=["Bold","Italic","Underline",
"InsertUnorderedList","InsertOrderedList"];a.element.hide();a.holder=c('<div class="mac-tinylight">').insertBefore(a.element).hide();a.holder.height(a.options.height);a.frame=c('<iframe class="mac-tinylight-frame" frameborder="0" dir="ltr" wrap="soft">').appendTo(a.holder);a.toolbar=c('<div class="mac-tinylight-toolbar" unselectable="on">').appendTo(a.holder);navigator.userAgent.match(/MSIE/)||(b.push("Undo"),b.push("Redo"));c.each(b,function(b,c){a._addButton(c)});a.wnd=a.frame.get(0).contentWindow;
a.doc=a.wnd.document;a.doc.open();a.doc.write('<!DOCTYPE html><title></title><meta charset="utf-8"><link rel="stylesheet" href="http://css.cdn.tl/normalize.css"><style>body{margin:.5em;font-family:'+a.options.fontFamily+";font-size:"+a.options.fontSize+";background-color:"+a.options.backgroundColor+";}p,ul,ol{margin:2px 0}p{background:#eee;}li{background:#ccc}</style><body></body>");a.doc.close();a.setHtml(""===c.trim(a.element.val())?"<p>&nbsp;</p>":a.element.val());a.doc.body.contentEditable?a.doc.body.contentEditable=
!0:a.doc.designMode="on";try{a.doc.execCommand("styleWithCSS",0,!1)}catch(f){try{a.doc.execCommand("useCSS",0,!0)}catch(g){try{a.doc.execCommand("styleWithCSS",!1,!1)}catch(d){}}}c(a.doc).on("keyup",function(b){var c,d;13===b.keyCode&&!b.shiftKey&&(jQuery(a.doc.body).children("br").filter(function(){return"li"!==this.parentNode.nodeName}).remove(),(c=a._selectedNode())&&"pre"===c.tagName.toLowerCase()&&a.doc.execCommand("FormatBlock",!1,a.options.blockTag));if(8!==b.keyCode&&17!==b.keyCode&&46!==
b.keyCode&&224!==b.keyCode&&!b.metaKey&&!b.ctrlKey){c=a._selectedNode();d=c.tagName.toLowerCase();if("strong"===d||"b"===d||"em"===d||"i"===d||"sub"===d||"sup"===d||"a"===d)d=c.parentNode.tagName.toLowerCase();("body"===d||"div"===d||"p"===d)&&a.doc.execCommand("FormatBlock",!1,a.options.blockTag)}(86===b.keyCode&&b.ctrlKey||45===b.keyCode&&b.shiftKey)&&a.setHtml(a.getHtml())});c(a.doc).on("keyup mouseup",function(){a._updateToolbar();a.nowLength=a.doc.body.innerHTML.length;Math.abs(a.nowLength-a.wasLength)>
a.options.cleanupLengthTrigger&&a.setHtml(a.getHtml());a.wasLength=a.nowLength;a.options.updateOnKeyUp&&a.element.val(a.doc.body.innerHTML)});c(navigator.userAgent.match(/MSIE/)?a.doc:a.wnd).on("blur deactivate",function(){a.setHtml(a.getHtml())});a.holder.show()},_setOption:function(a,b){this._super("_setOption",a,b);switch(a){case "height":this.holder.height(b);break;case "fontSize":this.doc.body.style.fontSize=b;break;case "fontFamily":this.doc.body.style.fontFamily=b;break;case "backgroundColor":this.doc.body.style.backgroundColor=
b}},destroy:function(){this.setHtml(this.getHtml());this.holder.remove();this.element.show();this._super("destroy")}})})(jQuery);